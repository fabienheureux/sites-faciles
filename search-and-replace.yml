# search-and-replace.yml

# Package name for namespacing (used in {package_name} placeholder)
package_name: wagtail_dsfr

apps:
  - blog
  - events
  - forms
  - content_manager
  - config
  - proconnect

# Named scopes (rules can reference these by name)
scopes:
  migrations: "**/migrations/**"
  templates: "**/templates/**"
  all: "**/*"

# File extensions considered "text" (configurable)
text_extensions:
  - .py
  - .html
  - .htm
  - .txt
  - .md
  - .csv
  - .json
  - .yaml
  - .yml
  - .po
  - .ini
  - .cfg
  - .rst
  - .xml
  - .js
  - .ts
  - .css
  - .scss

# Rules. Each rule may use:
#  - scope: reference to a named scope (scopes.<name>)
#  - path_glob: an explicit git ls-files pattern (overrides scope if present)
#  - literal: true -> do a literal string replace (no regex)
#  - search & replace are strings
rules:
  # ---------- Apps configuration ----------
  # Transform app name in AppConfig classes
  - search: '(    name = ")({app})(")'
    replace: '\1{package_name}.\2\3\n    label = "{package_name}_\2"'
    path_glob: "**/apps.py"

  # ---------- Generic patterns (expanded per app) ----------
  - search: 'to="{app}\.'
    replace: 'to="{package_name}_{app}.'
    scope: migrations

  - search: 'through="{app}\.'
    replace: 'through="{package_name}_{app}.'
    scope: migrations

  - search: 'app_name="{app}'
    replace: 'app_name="{package_name}_{app}'
    scope: migrations

  - search: 'apps\.get_model\(\"{app}\"'
    replace: 'apps.get_model("{package_name}_{app}"'
    scope: migrations

  - search: '\"{app}"'
    replace: '"{package_name}_{app}"'
    filter: 'replaces = \[(.*?)\]'
    scope: migrations

  - search: '\"{app}"'
    replace: '"{package_name}_{app}"'
    filter: 'dependencies = \[(.*?)\]'
    scope: migrations

  - search: '"page_type": \["{app}'
    replace: '"page_type": ["{package_name}_{app}'
    scope: migrations

  - search: 'from {app}\.'
    replace: "from {package_name}.{app}."
    scope: all

  - search: "from {app} import"
    replace: "from {package_name}.{app} import"
    scope: all

  - search: 'include\("{app}\.'
    replace: 'include("{package_name}.{app}.'
    scope: all

  - search: 'template="{app}/'
    replace: 'template="{package_name}_{app}/'
    scope: all

  - search: 'include\ "{app}/'
    replace: 'include "{package_name}_{app}/'
    scope: templates

  - search: 'template = \("{app}'
    replace: 'template = ("{package_name}_{app}'
    scope: all

  - search: 'template = "{app}/'
    replace: 'template = "{package_name}_{app}/'
    scope: all

  - search: 'template_name = "{app}/'
    replace: 'template_name = "{package_name}_{app}/'
    scope: all

  - search: '"template": "{app}/'
    replace: '"template": "{package_name}_{app}/'
    scope: all

  - search: '\ settings.{app}'
    replace: " settings.{package_name}_{app}"
    scope: all

  - search: '"{app}\.blocks'
    replace: '"{package_name}.{app}.blocks'
    scope: migrations

  - search: "import {app}"
    replace: "import {package_name}.{app}"
    scope: migrations

  # ---------- Special-case overrides ----------
  - search: 'content_manager\.models\.MonospaceField'
    replace: "{package_name}.content_manager.models.MonospaceField"
    scope: migrations

  - search: " content_manager.blocks.IconPickerBlock"
    replace: " {package_name}.content_manager.blocks.IconPickerBlock"
    scope: migrations
    literal: true

  - search: '"content_manager.utils.'
    replace: '"{package_name}.content_manager.utils.'
    scope: all
    literal: true

  - search: "content_manager.models.{package_name}.content_manager"
    replace: "{package_name}_content_manager.models.{package_name}.content_manager"
    scope: all
    literal: true

  - search: '"blog.Person"'
    replace: '"{package_name}_blog.Person"'
    scope: all
    literal: true

  - search: '"blog.Category"'
    replace: '"{package_name}_blog.Category"'
    scope: all
    literal: true

  - search: '"blog.Organization"'
    replace: '"{package_name}_blog.Organization"'
    scope: all
    literal: true

  - search: '"blog.BlogEntryPage"'
    replace: '"{package_name}_blog.BlogEntryPage"'
    scope: all
    literal: true

  - search: '"blog.BlogIndexPage"'
    replace: '"{package_name}_blog.BlogIndexPage"'
    scope: all
    literal: true

  - search: '"events.EventEntryPage"'
    replace: '"{package_name}_events.EventEntryPage"'
    scope: all
    literal: true

  - search: '"events.EventsIndexPage"'
    replace: '"{package_name}_events.EventsIndexPage"'
    scope: all
    literal: true

  - search: '"content_manager.MegaMenu'
    replace: '"{package_name}_content_manager.MegaMenu'
    path_glob: "**/models.py"
    literal: true

  - search: '"content_manager.ContentPage"'
    replace: '"{package_name}_content_manager.ContentPage"'
    scope: all
    literal: true

  - search: '"content_manager.Tag"'
    replace: '"{package_name}_content_manager.Tag"'
    scope: all
    literal: true

  # ---------- Swappable model helpers ----------
  # Convert PageChooserBlock with page_type to custom chooser blocks
  - search: 'blocks\.PageChooserBlock\(label=_\("Blog"\), page_type="wagtail_dsfr_blog\.BlogIndexPage"\)'
    replace: 'BlogIndexChooserBlock(label=_("Blog"))'
    scope: all

  - search: 'blocks\.PageChooserBlock\(label=_\("Event calendar"\), page_type="wagtail_dsfr_events\.EventsIndexPage"\)'
    replace: 'EventsIndexChooserBlock(label=_("Event calendar"))'
    scope: all

  # Add import for chooser blocks when needed
  - search: "from wagtail import blocks\nfrom wagtail.blocks import BooleanBlock\nfrom wagtail.snippets.blocks import SnippetChooserBlock"
    replace: "from wagtail import blocks\nfrom wagtail.blocks import BooleanBlock\nfrom wagtail.snippets.blocks import SnippetChooserBlock\n\nfrom {package_name}.content_manager.blocks.choosers import (\n    BlogIndexChooserBlock,\n    EventsIndexChooserBlock,\n)"
    path_glob: "**/blocks/related_entries.py"
    literal: true

  - search: "from wagtail_dsfr.utils.models import"
    replace: "from {package_name}.utils.models import"
    scope: all
    literal: true

  - search: "from wagtail_dsfr.content_manager.blocks.choosers import"
    replace: "from {package_name}.content_manager.blocks.choosers import"
    scope: all
    literal: true

  # Settings keys for swappable models
  - search: "WAGTAIL_DSFR_BLOG_INDEX_MODEL"
    replace: "{package_name_upper}_BLOG_INDEX_MODEL"
    scope: all
    literal: true

  - search: "WAGTAIL_DSFR_BLOG_ENTRY_MODEL"
    replace: "{package_name_upper}_BLOG_ENTRY_MODEL"
    scope: all
    literal: true

  - search: "WAGTAIL_DSFR_EVENTS_INDEX_MODEL"
    replace: "{package_name_upper}_EVENTS_INDEX_MODEL"
    scope: all
    literal: true

  - search: "WAGTAIL_DSFR_EVENTS_ENTRY_MODEL"
    replace: "{package_name_upper}_EVENTS_ENTRY_MODEL"
    scope: all
    literal: true

  - search: "WAGTAIL_DSFR_CONTENT_PAGE_MODEL"
    replace: "{package_name_upper}_CONTENT_PAGE_MODEL"
    scope: all
    literal: true

  # ---------- Abstract model class names ----------
  # Convert BlogIndexPage to AbstractBlogIndexPage
  - search: "class BlogIndexPage("
    replace: "class AbstractBlogIndexPage("
    path_glob: "**/blog/models.py"
    literal: true

  - search: "class BlogEntryPage("
    replace: "class AbstractBlogEntryPage("
    path_glob: "**/blog/models.py"
    literal: true

  - search: "class EventsIndexPage("
    replace: "class AbstractEventsIndexPage("
    path_glob: "**/events/models.py"
    literal: true

  - search: "class EventEntryPage("
    replace: "class AbstractEventEntryPage("
    path_glob: "**/events/models.py"
    literal: true

  - search: "class ContentPage("
    replace: "class AbstractContentPage("
    path_glob: "**/content_manager/models.py"
    literal: true

  # Add concrete implementations after abstract classes
  - search: '    class Meta:\n        verbose_name = _("Blog index")'
    replace: '    class Meta:\n        abstract = True\n        verbose_name = _("Blog index")\n\n\nclass BlogIndexPage(AbstractBlogIndexPage):\n    """\n    Default concrete implementation of blog index page.\n    Can be replaced by a custom implementation using {package_name_upper}_BLOG_INDEX_MODEL setting.\n    """\n    pass'
    path_glob: "**/blog/models.py"
    literal: true

  - search: '    class Meta:\n        verbose_name = _("Blog page")'
    replace: '    class Meta:\n        abstract = True\n        verbose_name = _("Blog page")\n\n\nclass BlogEntryPage(AbstractBlogEntryPage):\n    """\n    Default concrete implementation of blog entry page.\n    Can be replaced by a custom implementation using {package_name_upper}_BLOG_ENTRY_MODEL setting.\n    """\n    pass'
    path_glob: "**/blog/models.py"
    literal: true
